"use strict";$(function(){function e(e,o){o.children("option:not(.not-remove)").remove(),tool.ajax("area:areas/"+e+"/subList",{},function(e){var a="",i=e.data.content;if(i.length>0)for(var t=e.data.content,r=0;r<t.length;r++)a+='<option data-id="'+t[r].id+'" value="'+t[r].name+'">'+t[r].name+"</option>";else a="暂无数据";o.append(a)})}function o(){tool.ajax("shop:goods/"+t,{},function(e){var o=e.data;a.items[0].goodsId=o.id,$(".order-info2").append('<img class="fl" src="'+o.imageFull+'" alt="">\n      <ul class="fl order-infolist">\n        <li class="infolist1">'+o.name+o.specification+'<span class="number fr">x1 </span></li>\n        <li class="infolist2"><span class="price">￥'+o.price.toFixed(2)+'</span></li>\n        <li class="infolist3">配送方式：快递（免邮）</li>\n      </ul>'),$(".pay-total").append("<span>￥"+o.price.toFixed(2)+"</span>")})}$(".banner-right li:eq(2)").addClass("active").siblings().removeClass("active");var a={items:[{amount:1,goodsId:0}]},i={defaultAddr:!0};$.cookie("userId")||($("#form-errorbox,.mask").show(),$(".form-tipxbox").find(".error-tipsbox div").text("请先登录，正在跳转登录页面..."),$(".my-know").click(function(){window.location.href="login.html"}),setTimeout(function(){window.location.href="login.html"},5e3));var t=+tool.getUrlParam("id");a.userId=i.userId=parseInt($.cookie("userId")),tool.ajax("addr:addr",{userId:a.userId,page:0,size:1,defaultAddr:!0},function(e){if(0==e.data.content.length)$(".area-chosen1").show();else{var o=e.data.content[0];a.receiveAddrId=o.id,$(".area-chosen2").show(),tool.ajax("area:areas/batch",{ids:[o.provinceId,o.cityId,o.districtId].join(",")},function(e){var a=e.data.content,i=a[0].name+a[1].name+a[2].name;$(".area-chosen2 .chosen-addr").text("收货地址："+i+o.location),$(".area-chosen2 .chosen-addrname").text("收货人："+o.userName),$(".area-chosen2 .chosen-addrname").append('<span class="chosen-addrphone">联系电话：'+o.mobile+"</span>")})}}),$(".chosen-addrnew a").click(function(){$(".area-chosen2").hide(),$(".area-chosen1,.default-adrr").show()}),$(".default-adrr").click(function(){$(".area-chosen2").show(),$(".area-chosen1,.default-adrr").hide()}),e(0,$("#province10")),$("#province10").change(function(){$("#district10").children("option:not(.not-remove)").remove();var o=$(this).children("option:selected").data("id");i.provinceId=o,o?e(o,$("#city10")):$("#city10").children("option:not(.not-remove)").remove()}),$("#city10").change(function(){var o=$(this).children("option:selected").data("id");i.cityId=o,o?e(o,$("#district10")):$("#district10").children("option:not(.not-remove)").remove()}),$("#district10").change(function(){var e=$(this).children("option:selected").data("id");i.districtId=e}),o(),$(".qrcode-box i").click(function(){$(".mask,.qrcode-box").hide(),$(".qrcode-box").find(".weixin-img").children().remove(),setTimeout(function(){$("#form-errorbox,.mask").show(),$(".form-tipxbox").find(".error-tipsbox div").text("您已取消支付，支付失败！")},1e3)}),$(".order-btn").click(function(){if("block"==$(".area-chosen1").css("display")){i.userName=$(".input-name").val(),i.mobile=$(".input-phone").val(),i.location=$(".address-detail").val();for(var e=[{name:"userName",tips:"请填写收货人姓名"},{name:"mobile",tips:"请填写手机号码"},{name:"mobile",tips:"手机号码格式错误",val:i.mobile},{name:"provinceId",tips:"请选择省份"},{name:"cityId",tips:"请选择市级"},{name:"districtId",tips:"请选择县区"},{name:"location",tips:"请填写详细地址"}],o=0;o<e.length;o++){if(!i[e[o].name])return $(".error-tipsbox div").text(e[o].tips),void $(".form-tipxbox,.mask").show();if(e[o].val&&!/^[1][3,4,5,7,8][0-9]{9}$/.test(e[o].val))return $(".error-tipsbox div").text(e[o].tips),void $(".form-tipxbox,.mask").show()}}return $(".pay-way li").hasClass("active")?("block"==$(".area-chosen1").css("display")&&tool.ajax2("addr:addr",i,function(e){a.receiveAddrId=e.data.id},!1),void tool.ajax2("shop:orders",a,function(e){if(0==e.code){var o=e.data.baseOrder.orderNo;$(".pay-way li:last-child").hasClass("active")?tool.ajax2("payOrder:pay/wx",{orderNo:o,userId:a.userId,wxTradeType:"NATIVE"},function(e){var i=e.data.code_url;$(".mask,.qrcode-box").show(),$("#qrcodeCanvas").qrcode({render:"canvas",text:i,width:"250",height:"250",background:"#ffffff",foreground:"#000000",src:"../images/logo2.jpg"});var t=setInterval(function(){tool.ajax("shop:orders",{userId:a.userId,orderNo:o,page:0,size:1},function(e){0==e.code&&2==e.data.content[0].payStatus&&(clearInterval(t),$(".qrcode-box").hide(),$("#form-errorbox").show(),$(".form-tipxbox").addClass("form-successbox").find(".error-tipsbox div").text("支付成功，正在跳转个人中心..."),setTimeout(function(){window.location.href="my.html?tag=6"},4e3))})},3e3)}):tool.ajax2("payOrder:pay/aliPay",{orderNo:o,userId:a.userId,aliTradeType:"PagePay"},function(e){$("body").append(e.data.orderStr),setTimeout(function(){document.punchout_form.submit()},200)})}else $(".error-tipsbox div").text(e.msg||"购买失败，稍后重试！"),$(".form-tipxbox,.mask").show()})):($(".error-tipsbox div").text("请选择支付方式"),void $(".form-tipxbox,.mask").show())}),$(".close-form,.my-know").click(function(){$(".form-tipxbox,.mask").hide()}),$(".pay-way li").click(function(){$(this).addClass("active").siblings().removeClass("active")})});