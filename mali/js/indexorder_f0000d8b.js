"use strict";$(function(){function e(e,o){o.children("option:not(.not-remove)").remove(),tool.ajax("area:areas/"+e+"/subList",{},function(e){var i="",t=e.data.content;if(t.length>0)for(var n=e.data.content,a=0;a<n.length;a++)i+='<option data-id="'+n[a].id+'" value="'+n[a].name+'">'+n[a].name+"</option>";else i="暂无数据";o.append(i)})}function o(e){tool.ajax("machine:machine/"+e.id,e,function(e){var o=e.data;$(".indexdetail-tit").html('<i class="map"></i>当前位置：<a class="link" href="index.html">首页</a>>买农机>'+o.title+">订单提交"),$(".order-info").html('<img class="fl" src="'+o.images[0]+'" alt="">\n      <ul class="fl order-infolist">\n        <li class="infolist1">'+o.title+'</li>\n        <li class="infolist2"><span class="text">销售价： </span><span class="price">￥'+o.price.toFixed(2)+'</span></li>\n        <li class="infolist3">所需缴基本服务费：'+(o.service.basicFee+o.service.warrantyFee).toFixed(2)+"元</li>\n      </ul>")})}$(".banner-right li:eq(0)").addClass("active").siblings().removeClass("active");var i={},t={};$.cookie("userId")||($("#form-errorbox,.mask").show(),$(".form-tipxbox").find(".error-tipsbox div").text("请先登录，正在跳转登录页面..."),$(".my-know").click(function(){window.location.href="login.html"}),setTimeout(function(){window.location.href="login.html"},5e3)),e(0,$("#province10")),$("#province10").change(function(){$("#district10").children("option:not(.not-remove)").remove();var o=$(this).children("option:selected").data("id");t.provinceId=o,o?e(o,$("#city10")):$("#city10").children("option:not(.not-remove)").remove()}),$("#city10").change(function(){var o=$(this).children("option:selected").data("id");t.cityId=o,o?e(o,$("#district10")):$("#district10").children("option:not(.not-remove)").remove()}),$("#district10").change(function(){var e=$(this).children("option:selected").data("id");t.districtId=e});var n,a,r=+tool.getUrlParam("id")||1;n=new AMap.Map("container",{resizeEnable:!0}),n.plugin("AMap.Geolocation",function(){a=new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4,buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:!0,buttonPosition:"RB"}),n.addControl(a),a.getCurrentPosition(),AMap.event.addListener(a,"complete",function(e){i={id:r,clientLon:e.position.lng,clientLat:e.position.lat,projection:"withRegion"},o(i)}),AMap.event.addListener(a,"error",function(){i={id:r,projection:"withRegion"},o(i)})}),t.machineId=r,$(".order-btn").click(function(){t.realname=$(".input-name").val(),t.phone=$(".input-phone").val(),t.location=$(".address-detail").val();for(var e=[{name:"realname",tips:"请填写姓名"},{name:"phone",tips:"请填写手机号码"},{name:"phone",tips:"手机号码格式错误",val:t.phone},{name:"provinceId",tips:"请选择省份"},{name:"cityId",tips:"请选择市级"},{name:"districtId",tips:"请选择县区"},{name:"location",tips:"请填写详细地址"}],o=0;o<e.length;o++){if(!t[e[o].name])return $(".error-tipsbox div").text(e[o].tips),void $(".form-tipxbox,.mask").show();if(e[o].val&&!/^[1][3,4,5,7,8][0-9]{9}$/.test(e[o].val))return $(".error-tipsbox div").text(e[o].tips),void $(".form-tipxbox,.mask").show()}return $(".pay-way li").hasClass("active")?(t.userId=parseInt($.cookie("userId")),t.serviceFeeType=+tool.getUrlParam("f")||1,void tool.ajax2("machine:order",t,function(e){if(0==e.code){var o=e.data.baseOrder.orderNo;$(".pay-way li:last-child").hasClass("active")?tool.ajax2("payOrder:pay/wx",{orderNo:o,userId:t.userId,wxTradeType:"NATIVE"},function(e){var i=e.data.code_url;$(".mask,.qrcode-box").show(),$("#qrcodeCanvas").qrcode({render:"canvas",text:i,width:"250",height:"250",background:"#ffffff",foreground:"#000000",src:"../images/logo2.jpg"});var n=setInterval(function(){tool.ajax("machine:order",{userId:t.userId,orderNo:o,page:0,size:1},function(e){0==e.code&&2==e.data.content[0].baseOrder.payStatus&&(clearInterval(n),$(".qrcode-box").hide(),$("#form-errorbox").show(),$(".form-tipxbox").addClass("form-successbox").find(".error-tipsbox div").text("支付成功，正在跳转个人中心..."),setTimeout(function(){window.location.href="my.html?tag=4"},4e3))})},3e3)}):tool.ajax2("payOrder:pay/aliPay",{orderNo:o,userId:t.userId,aliTradeType:"PagePay"},function(e){$("body").append(e.data.orderStr),setTimeout(function(){document.punchout_form.submit()},200)})}else $(".error-tipsbox div").text(e.msg||"发布失败，稍后重试！"),$(".form-tipxbox,.mask").show()})):($(".error-tipsbox div").text("请选择支付方式"),void $(".form-tipxbox,.mask").show())}),$(".pay-way li").click(function(){$(this).addClass("active").siblings().removeClass("active")}),$(".close-form,.my-know").click(function(){$(".form-tipxbox,.mask").hide()}),$(".qrcode-box i").click(function(){$(".mask,.qrcode-box").hide(),$(".qrcode-box").find(".weixin-img").children().remove(),setTimeout(function(){$("#form-errorbox,.mask").show(),$(".form-tipxbox").find(".error-tipsbox div").text("您已取消支付，支付失败！")},1e3)})});