"use strict";$(function(){function e(e,i){i.children("option:not(.not-remove)").remove(),tool.ajax("area:areas/"+e+"/subList",{},function(e){var t="",n=e.data.content;if(n.length>0)for(var o=e.data.content,a=0;a<o.length;a++)t+='<option data-id="'+o[a].id+'" value="'+o[a].name+'">'+o[a].name+"</option>";else t="暂无数据";i.append(t)})}function i(e,i,t){setTimeout(function(){i.parent(".item-container").show()},100),t||tool.ajax(e,{},function(e){var t="",n=e.data.content;if(n.length>0)for(var o=e.data.content,a=0;a<o.length;a++)t+='<li data-id="'+o[a].id+'" data-name="'+o[a].name+'">'+o[a].name+"</li>";else t="暂无数据";i.append(t)})}$(".banner-right li:eq(1)").addClass("active").siblings().removeClass("active"),$.cookie("userId")||($(".error-tipsbox div").text("请先登陆，再发布农机！"),$(".form-tipxbox,.mask").show(),$(".my-know").click(function(){window.location.href="login.html"}),setTimeout(function(){window.location.href="login.html"},2e3));var t,n,o=!1,a=!1,s=!1,r=!1,c="",d={images:[],boughtTime:""},m={};t=new AMap.Map("container",{resizeEnable:!0}),t.plugin("AMap.Geolocation",function(){n=new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4,buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:!0,buttonPosition:"RB"}),t.addControl(n),n.getCurrentPosition(),AMap.event.addListener(n,"complete",function(e){d.lon=e.position.lng,d.lat=e.position.lat})}),e(0,$("#province10")),$("#province10").change(function(){$("#district10").children("option:not(.not-remove)").remove();var i=$(this).children("option:selected").data("id");d.provinceId=i,i?e(i,$("#city10")):$("#city10").children("option:not(.not-remove)").remove()}),$("#city10").change(function(){var i=$(this).children("option:selected").data("id");d.cityId=i,i?e(i,$("#district10")):$("#district10").children("option:not(.not-remove)").remove()}),$("#district10").change(function(){var e=$(this).children("option:selected").data("id");d.districtId=e}),$(".chosen-pinglei input").focus(function(){$(this).parent(".chosen-item").siblings(".chosen-item").children(".item-container,.brand-model").hide(),i("machine:category/children/0",$(".chosen-pinglei .item-box"),o),o=!0}),$(".chosen-pinglei .item-box").on("click","li",function(){var e=$(this).data("id");d.categoryId=e;var i=$(this).data("name");$(this).parents(".item-container").siblings("input").val(i),$(this).parents(".item-container").hide()}),$(".chosen-brand input").focus(function(){$(this).parent(".chosen-item").siblings(".chosen-item").children(".item-container,.brand-model").hide(),i("machine:brand?page=0&size=200",$(".brand-model .brand-content"),a),$(".brandmodel-tab li").eq(0).addClass("active").siblings().removeClass("active"),$(".brand-model").show(),$(".brand-content").show(),$(".model-content").hide(),a=!0}),$(".brandmodel-tab li").click(function(){var e=$(this).index();$(".brandmodel-content").eq(e).show().siblings(".brandmodel-content").hide(),$(this).addClass("active").siblings().removeClass("active")}),$(".brand-content").on("click","li",function(){var e=$(this).data("id");c=$(this).data("name"),d.brandId=e,$(".model-content").children().remove(),i("machine:model?page=0&size=200&brandId="+e,$(".brand-model .model-content"),!1),$(".brand-content").hide(),$(".model-content").show(),$(".brandmodel-tab li:nth-child(2)").addClass("active").siblings().removeClass("active"),$(".brandmodel-input").val("品牌："+c)}),$(".model-content").on("click","li",function(){var e=$(this).data("id"),i=$(this).data("name");d.modelId=e,$(".brand-model").hide(),$(".brandmodel-input").val("品牌："+c+" ，型号："+i)}),$(".close-chosenbox").click(function(){$(this).parent(".item-container,.brand-model").hide()}),$(".chosen-brand .item-box").on("click","li",function(){var e=$(this).data("id");d.brandId=e;var i=$(this).data("name");$(this).parents(".item-container").siblings("input").val(i),$(this).parents(".item-container").hide()}),$(".chosen-horsepower input").focus(function(){$(this).parent(".chosen-item").siblings(".chosen-item").children(".item-container,.brand-model").hide(),i("machine:horsepower-section?page=0&size=100",$(".chosen-horsepower .item-box"),s),s=!0}),$(".chosen-horsepower .item-box").on("click","li",function(){var e=$(this).data("id");d.horsepower=e;var i=$(this).data("name");$(this).parents(".item-container").siblings("input").val(i),$(this).parents(".item-container").hide()}),$(".chosen-time input").focus(function(){$(this).parent(".chosen-item").siblings(".chosen-item").children(".item-container,.brand-model").hide(),i("machine:usedtime-section?page=0&size=100",$(".chosen-time .item-box"),r),r=!0}),$(".chosen-time .item-box").on("click","li",function(){var e=$(this).data("id");d.usedTime=e;var i=$(this).data("name");$(this).parents(".item-container").siblings("input").val(i),$(this).parents(".item-container").hide()}),$(".close-form,.my-know").click(function(){$(".form-tipxbox,.mask").hide(),$(".form-tipxbox").removeClass("form-successbox form-successbox2")}),$(".buy-time").each(function(){$(this).ionDatePicker({lang:"zh-cn",format:"YYYY-MM-DD",onReady:function(e){d.boughtTime=e+" 00:00:00",d.boughtTime=new Date(d.boughtTime).toISOString()}})}),d.boughtTime="",$(".sell-btn").click(function(){if(0==d.images.length)return $(".error-tipsbox div").text("请上传图片"),void $(".form-tipxbox,.mask").show();d.description=$(".address-detail").val(),d.price=$(".price-input").val(),m.phone=$(".input-phone").val();for(var e=[{name:"categoryId",tips:"请选择农机品类"},{name:"brandId",tips:"请选择品牌"},{name:"modelId",tips:"请选择型号"},{name:"horsepower",tips:"请选择配套动力"},{name:"boughtTime",tips:"请填写购买时间"},{name:"usedTime",tips:"请选择行驶时间"},{name:"price",tips:"请填写转让价格"},{name:"description",tips:"请输入农机的具体描述"},{name:"provinceId",tips:"请选择省份"},{name:"cityId",tips:"请选择市级"},{name:"districtId",tips:"请选择县区"}],i=0;i<e.length;i++)if(!d[e[i].name])return $(".error-tipsbox div").text(e[i].tips),void $(".form-tipxbox,.mask").show();if(d.price=+d.price,!/(^[1-9]\d*(\.\d{1,2})?$)|(^0(\.\d{1,2})?$)/.test(d.price))return $(".error-tipsbox div").text("转让价格格式错误"),void $(".form-tipxbox,.mask").show();if(!m.phone)return $(".error-tipsbox div").text("请填写手机号码"),void $(".form-tipxbox,.mask").show();if(!/^[1][3,4,5,7,8][0-9]{9}$/.test(m.phone))return $(".error-tipsbox div").text("手机号码格式错误"),void $(".form-tipxbox,.mask").show();if(!m.image)return $(".error-tipsbox div").text("请上传购买凭证图片"),void $(".form-tipxbox,.mask").show();d.userId=parseInt($.cookie("userId"));for(var i=0;i<d.images.length;i++)d.images[i]=d.images[i].replace(rootUpload,"");tool.ajax2("machine:machine",d,function(e){return 0==e.code?(console.log(11111,e),void(m.machineId=e.data.id)):($(".error-tipsbox div").text("发布失败，稍后重试！"),void $(".form-tipxbox,.mask").show())})}),$("#uploadPic1").change(function(){var e=new FormData;e.append("files",$("#uploadPic1").prop("files")[0]),$.ajax({type:"post",url:rootApi+"vendor:oss/files",data:e,processData:!1,contentType:!1,dataType:"json",success:function(e){if(0!=e.code)return $(".error-tipsbox div").text("上传失败，稍后重试"),void $(".form-tipxbox,.mask").show();d.images.push(rootUpload+e.data.content[0]);var i="";$(".chosen-images .img-list").children().remove();for(var t=0;t<d.images.length;t++)i+='<li>\n    					<a name="del-images" class="del-images" data-index="'+t+'" href="javascript:;"></a>\n    					<img src="'+d.images[t]+'" alt="">\n    				</li>';$(".chosen-images .img-list").append(i)},error:function(){$(".error-tipsbox div").text("上传失败，稍后重试"),$(".form-tipxbox,.mask").show()}})}),$("#uploadPic2").change(function(){var e=new FormData;e.append("files",$("#uploadPic2").prop("files")[0]),$.ajax({type:"post",url:rootApi+"vendor:oss/files",data:e,processData:!1,contentType:!1,dataType:"json",success:function(e){return 0!=e.code?($(".error-tipsbox div").text("上传失败，稍后重试"),void $(".form-tipxbox,.mask").show()):(m.image=rootUpload+e.data.content[0],void $(".pingzheng-pic").attr("src",rootUpload+e.data.content[0]).show())},error:function(){$(".error-tipsbox div").text("上传失败，稍后重试"),$(".form-tipxbox,.mask").show()}})}),$(".chosen-images .img-list").on("click",".del-images",function(){var e=$(this).data("index");d.images.splice(e,1);var i="";$(".chosen-images .img-list").children().remove();for(var t=0;t<d.images.length;t++)i+='<li>\n        <a data-index="'+t+'" href="javascript:;"></a>\n        <img src="'+d.images[t]+'" alt="">\n      </li>';$(".chosen-images .img-list").append(i)})});